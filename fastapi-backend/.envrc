# Auto-activate Python virtual environment when entering directory
# Requires direnv: https://direnv.net/

# Create virtual environment if it doesn't exist
if [[ ! -d ".venv" ]]; then
    echo "Creating virtual environment with uv..."
    uv venv
fi

# Activate the virtual environment
source .venv/bin/activate

# Install dependencies if they're not installed or lockfile is newer
if [[ ! -f ".venv/.deps_installed" ]] || [[ "uv.lock" -nt ".venv/.deps_installed" ]] || [[ "pyproject.toml" -nt ".venv/.deps_installed" ]]; then
    echo "Installing dependencies with uv sync..."
    uv sync --dev
    touch .venv/.deps_installed
fi

# Load environment variables from .env if it exists
if [[ -f ".env" ]]; then
    dotenv .env
fi

# Add some helpful aliases
alias run="python run.py"
alias test="pytest"
alias lint="black . && isort . && flake8"
alias migrate="alembic upgrade head"
alias makemigration="alembic revision --autogenerate"
alias sync="uv sync --dev"
alias lock="uv lock"
alias update="uv lock --upgrade"
alias extract-openapi="python scripts/extract_openapi.py"

echo "ðŸš€ Project Showcase API environment activated!"
echo "   - Virtual environment: $(which python)"
echo "   - FastAPI version: $(python -c 'import fastapi; print(fastapi.__version__)')"
echo ""
echo "Quick commands:"
echo "   run           - Start the development server"
echo "   test          - Run tests"
echo "   lint          - Format and lint code"
echo "   migrate       - Apply database migrations"
echo "   makemigration - Create new migration"
echo "   sync          - Sync dependencies (uv sync --dev)"
echo "   lock          - Update lockfile (uv lock)"
echo "   update        - Update and upgrade dependencies"
echo "   extract-openapi - Extract OpenAPI spec to openapi.json"