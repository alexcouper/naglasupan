# Backend API Implementation Plan - FastAPI + PostgreSQL

## Project Overview
Developer project showcasing platform with user authentication, project submissions, admin approval workflow, public browsing, and monthly prize system.

## Tech Stack
- **Framework**: FastAPI
- **Database**: PostgreSQL 
- **ORM**: SQLAlchemy 2.0 (async)
- **Validation**: Pydantic V2
- **Authentication**: JWT with FastAPI-Users
- **File Storage**: AWS S3 or Railway volumes
- **Task Queue**: Celery + Redis (for monthly stats processing)
- **Deployment**: Railway

## Database Schema

### Users Table
```sql
users:
  id: UUID (Primary Key)
  email: str (Unique, Index)
  username: str (Unique, Index) 
  password_hash: str
  first_name: str
  last_name: str
  is_verified: bool (default: False)
  is_superuser: bool (default: False)
  is_active: bool (default: True)
  created_at: datetime
  updated_at: datetime
```

### Projects Table
```sql
projects:
  id: UUID (Primary Key)
  title: str (Index)
  description: text
  long_description: text (optional)
  website_url: str
  github_url: str (optional)
  demo_url: str (optional)
  screenshot_urls: list[str] (JSON field)
  tech_stack: list[str] (JSON field)
  monthly_visitors: int (default: 0)
  status: enum ['pending', 'approved', 'rejected'] (Index)
  rejection_reason: str (optional)
  owner_id: UUID (Foreign Key -> users.id)
  approved_by: UUID (Foreign Key -> users.id, optional)
  approved_at: datetime (optional)
  created_at: datetime (Index)
  updated_at: datetime
  is_featured: bool (default: False)
  submission_month: str (YYYY-MM format, Index)
```

### Tags Table
```sql
tags:
  id: UUID (Primary Key)
  name: str (Unique, Index)
  slug: str (Unique, Index)
  description: str (optional)
  color: str (hex color, optional)
  created_at: datetime
```

### Project Tags (Many-to-Many)
```sql
project_tags:
  project_id: UUID (Foreign Key -> projects.id)
  tag_id: UUID (Foreign Key -> tags.id)
  Primary Key: (project_id, tag_id)
```

### Monthly Prizes Table
```sql
monthly_prizes:
  id: UUID (Primary Key)
  month: str (YYYY-MM format, Unique)
  winner_project_id: UUID (Foreign Key -> projects.id, optional)
  runner_up_1_id: UUID (Foreign Key -> projects.id, optional)
  runner_up_2_id: UUID (Foreign Key -> projects.id, optional)
  prize_amount: decimal (optional)
  voting_end_date: datetime
  winner_announced_at: datetime (optional)
  created_at: datetime
```

### Project Views (Analytics)
```sql
project_views:
  id: UUID (Primary Key)
  project_id: UUID (Foreign Key -> projects.id, Index)
  ip_address: str (hashed for privacy)
  user_agent: str (optional)
  referrer: str (optional)
  viewed_at: datetime (Index)
  session_id: str (optional, for deduplication)
```

## API Endpoints Structure

### Authentication Endpoints
```
POST   /auth/register          # User registration
POST   /auth/login             # User login (returns JWT)
POST   /auth/logout            # Logout (blacklist token)
POST   /auth/refresh           # Refresh JWT token
POST   /auth/forgot-password   # Password reset request
POST   /auth/reset-password    # Password reset confirmation
GET    /auth/verify-email      # Email verification
GET    /auth/me                # Get current user info
PUT    /auth/me                # Update current user info
```

### Public Project Endpoints
```
GET    /projects               # List approved projects (with filtering/sorting)
GET    /projects/{id}          # Get single project details
POST   /projects/{id}/view     # Track project view (analytics)
GET    /projects/featured      # Get featured projects
GET    /projects/trending      # Get trending projects (by monthly visitors)
GET    /tags                   # List all available tags
GET    /monthly-prizes         # List monthly prize winners
GET    /monthly-prizes/current # Current month's competition info
```

### User Project Management
```
GET    /my/projects            # List user's own projects
POST   /my/projects            # Submit new project
GET    /my/projects/{id}       # Get user's project details
PUT    /my/projects/{id}       # Update project (only if pending/rejected)
DELETE /my/projects/{id}       # Delete project (only if pending/rejected)
POST   /my/projects/{id}/resubmit # Resubmit rejected project
```

### Admin Endpoints
```
GET    /admin/projects         # List all projects (with status filtering)
GET    /admin/projects/{id}    # Get project details for review
PUT    /admin/projects/{id}/approve   # Approve project
PUT    /admin/projects/{id}/reject    # Reject project (with reason)
PUT    /admin/projects/{id}/feature   # Feature/unfeature project
GET    /admin/users            # List all users
PUT    /admin/users/{id}/ban   # Ban/unban user
GET    /admin/analytics        # Platform analytics dashboard
POST   /admin/tags             # Create new tag
PUT    /admin/tags/{id}        # Update tag
DELETE /admin/tags/{id}        # Delete tag
GET    /admin/monthly-prizes   # Manage monthly prizes
POST   /admin/monthly-prizes   # Create monthly prize
PUT    /admin/monthly-prizes/{id} # Update prize (announce winner)
```

## Pydantic Models (Request/Response)

### User Models
```python
class UserCreate(BaseModel):
    email: EmailStr
    username: str
    password: str
    first_name: str
    last_name: str

class UserResponse(BaseModel):
    id: UUID
    email: str
    username: str
    first_name: str
    last_name: str
    created_at: datetime
    is_verified: bool

class UserUpdate(BaseModel):
    first_name: Optional[str] = None
    last_name: Optional[str] = None
    username: Optional[str] = None
```

### Project Models
```python
class ProjectCreate(BaseModel):
    title: str = Field(..., min_length=3, max_length=100)
    description: str = Field(..., min_length=10, max_length=500)
    long_description: Optional[str] = Field(None, max_length=5000)
    website_url: HttpUrl
    github_url: Optional[HttpUrl] = None
    demo_url: Optional[HttpUrl] = None
    screenshot_urls: List[HttpUrl] = Field(default_factory=list, max_items=5)
    tech_stack: List[str] = Field(..., min_items=1, max_items=10)
    tag_ids: List[UUID] = Field(..., min_items=1, max_items=5)

class ProjectResponse(BaseModel):
    id: UUID
    title: str
    description: str
    long_description: Optional[str]
    website_url: str
    github_url: Optional[str]
    demo_url: Optional[str]
    screenshot_urls: List[str]
    tech_stack: List[str]
    monthly_visitors: int
    status: ProjectStatus
    owner: UserResponse
    tags: List[TagResponse]
    created_at: datetime
    approved_at: Optional[datetime]
    is_featured: bool

class ProjectListResponse(BaseModel):
    projects: List[ProjectResponse]
    total: int
    page: int
    per_page: int
    pages: int

class ProjectFilters(BaseModel):
    tags: Optional[List[str]] = None  # Tag slugs
    tech_stack: Optional[List[str]] = None
    sort_by: Optional[str] = Field("created_at", regex="^(created_at|monthly_visitors|title)$")
    sort_order: Optional[str] = Field("desc", regex="^(asc|desc)$")
    search: Optional[str] = None
    page: int = Field(1, ge=1)
    per_page: int = Field(20, ge=1, le=100)
```

### Admin Models
```python
class ProjectApproval(BaseModel):
    approved: bool
    rejection_reason: Optional[str] = None
    is_featured: bool = False

class AdminProjectResponse(ProjectResponse):
    rejection_reason: Optional[str]
    approved_by: Optional[UserResponse]
    submission_month: str

class PlatformAnalytics(BaseModel):
    total_projects: int
    pending_projects: int
    approved_projects: int
    total_users: int
    monthly_submissions: Dict[str, int]
    top_tags: List[Dict[str, Union[str, int]]]
    top_tech_stack: List[Dict[str, Union[str, int]]]
```

## SQLAlchemy Models

### Key model implementations with relationships
```python
class User(SQLAlchemyBaseUserTableUUID, Base):
    __tablename__ = "users"
    
    username = Column(String, unique=True, index=True, nullable=False)
    first_name = Column(String, nullable=False)
    last_name = Column(String, nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    # Relationships
    projects = relationship("Project", back_populates="owner")
    approved_projects = relationship("Project", foreign_keys="Project.approved_by")

class Project(Base):
    __tablename__ = "projects"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    title = Column(String, nullable=False, index=True)
    description = Column(Text, nullable=False)
    # ... other fields
    status = Column(Enum(ProjectStatus), default=ProjectStatus.PENDING, index=True)
    owner_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False)
    approved_by = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=True)
    
    # Relationships
    owner = relationship("User", back_populates="projects", foreign_keys=[owner_id])
    approver = relationship("User", foreign_keys=[approved_by])
    tags = relationship("Tag", secondary="project_tags", back_populates="projects")
    views = relationship("ProjectView", back_populates="project")
```

## Authentication & Authorization

### JWT Configuration
- Access token expiry: 15 minutes
- Refresh token expiry: 30 days
- Algorithm: HS256
- Include user_id, username, is_superuser in payload

### Permission System
```python
def require_auth(current_user: User = Depends(get_current_user)):
    if not current_user.is_active:
        raise HTTPException(401, "Account disabled")
    return current_user

def require_admin(current_user: User = Depends(require_auth)):
    if not current_user.is_superuser:
        raise HTTPException(403, "Admin access required")
    return current_user

def require_project_owner(
    project_id: UUID,
    current_user: User = Depends(require_auth),
    db: Session = Depends(get_db)
):
    project = db.query(Project).filter(Project.id == project_id).first()
    if not project:
        raise HTTPException(404, "Project not found")
    if project.owner_id != current_user.id and not current_user.is_superuser:
        raise HTTPException(403, "Not authorized")
    return project
```

## Background Tasks & Analytics

### Monthly Analytics Processing
```python
# Celery task to update monthly visitor counts
@celery_app.task
def update_monthly_visitors():
    # Process ProjectView records from last month
    # Update Project.monthly_visitors field
    # Clean up old view records (keep last 3 months)
    pass

@celery_app.task
def announce_monthly_winners():
    # Determine winners based on monthly_visitors
    # Send notification emails
    # Update MonthlyPrize records
    pass
```

### View Tracking
- Async endpoint to track views without blocking
- IP-based deduplication (24-hour window)
- Session-based deduplication for better accuracy
- Batch insert views every 5 minutes

## File Upload Strategy

### Image Storage
- Screenshots stored in S3 or Railway volumes
- Image optimization pipeline (resize, compress)
- CDN integration for fast delivery
- File type validation (PNG, JPG, WebP only)
- Size limits: 2MB per image, max 5 images

## API Rate Limiting
- Public endpoints: 100 requests/minute per IP
- Authenticated endpoints: 1000 requests/minute per user
- Admin endpoints: No limit
- File upload: 5 uploads/minute per user

## Database Indexes
```sql
-- Performance critical indexes
CREATE INDEX idx_projects_status_created ON projects(status, created_at DESC);
CREATE INDEX idx_projects_monthly_visitors ON projects(monthly_visitors DESC);
CREATE INDEX idx_projects_owner_status ON projects(owner_id, status);
CREATE INDEX idx_project_views_project_viewed ON project_views(project_id, viewed_at);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
```

## Testing Strategy
- Unit tests for all business logic
- Integration tests for API endpoints
- Database transaction rollback for test isolation
- Mock external services (S3, email)
- Load testing for public endpoints

## Deployment Configuration

### Environment Variables
```
DATABASE_URL=postgresql://...
SECRET_KEY=...
JWT_SECRET_KEY=...
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
REDIS_URL=...
CELERY_BROKER_URL=...
EMAIL_SERVICE_API_KEY=...
ENVIRONMENT=production
```

### Railway Services
1. **FastAPI App** - Main web service
2. **PostgreSQL** - Database addon
3. **Redis** - Caching and Celery broker addon
4. **Celery Worker** - Background task processor

## OpenAPI Schema Generation
- FastAPI automatically generates OpenAPI 3.0 spec
- Available at `/docs` (Swagger UI) and `/redoc`
- Custom schema descriptions via docstrings
- Response model examples for better documentation
- Export schema for frontend client generation

This implementation provides a solid foundation for the developer project showcasing platform with room for future enhancements like voting systems, project recommendations, and advanced analytics.