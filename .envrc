# Auto-activate Python virtual environment when entering directory
# Requires direnv: https://direnv.net/

# Create virtual environment if it doesn't exist
if [[ ! -d ".venv" ]]; then
    echo "Creating virtual environment with uv..."
    uv venv
fi

# Activate the virtual environment
source .venv/bin/activate

# Install dependencies if they're not installed or pyproject.toml is newer
if [[ ! -f ".venv/.deps_installed" ]] || [[ "pyproject.toml" -nt ".venv/.deps_installed" ]]; then
    echo "Installing dependencies with uv..."
    # Install core dependencies
    uv pip install \
        fastapi>=0.104.1 \
        uvicorn[standard]>=0.24.0 \
        sqlalchemy>=2.0.23 \
        asyncpg>=0.29.0 \
        alembic>=1.12.1 \
        pydantic[email]>=2.5.0 \
        python-jose[cryptography]>=3.3.0 \
        passlib[bcrypt]>=1.7.4 \
        python-multipart>=0.0.6 \
        slowapi>=0.1.9 \
        python-dotenv>=1.0.0 \
        psycopg2-binary>=2.9.9
    
    # Install dev dependencies
    uv pip install \
        pytest>=7.4.0 \
        pytest-asyncio>=0.21.0 \
        pytest-cov>=4.1.0 \
        httpx>=0.25.0 \
        black>=23.0.0 \
        isort>=5.12.0 \
        flake8>=6.0.0 \
        mypy>=1.5.0
    
    touch .venv/.deps_installed
fi

# Load environment variables from .env if it exists
if [[ -f ".env" ]]; then
    dotenv .env
fi

# Add some helpful aliases
alias run="python run.py"
alias test="pytest"
alias lint="black . && isort . && flake8"
alias migrate="alembic upgrade head"
alias makemigration="alembic revision --autogenerate"

echo "ðŸš€ Project Showcase API environment activated!"
echo "   - Virtual environment: $(which python)"
echo "   - FastAPI version: $(python -c 'import fastapi; print(fastapi.__version__)')"
echo ""
echo "Quick commands:"
echo "   run          - Start the development server"
echo "   test         - Run tests"
echo "   lint         - Format and lint code"
echo "   migrate      - Apply database migrations"
echo "   makemigration - Create new migration"